# Changelog

All notable changes to this project will be documented in this file.

## [1.5.1] - 2026-01-02

### Fixed
- **Execution Animation & Visible Logs**: Implemented proper n8n integration using `N8nLlmTracing`
  - Now shows execution animation during model invocation
  - Input/output data visible in n8n execution UI (not just logs)
  - Token usage displayed in execution data
  - Proper integration with n8n's `addInputData()` and `addOutputData()` APIs
  - Matches behavior of built-in n8n LangChain chat model nodes

### Added
- `N8nLlmTracing` callback handler for proper n8n execution tracking
- `lodash` dependency for data processing in callbacks

### Changed
- Replaced basic `BaseCallbackHandler` with specialized `N8nLlmTracing`
- Execution data now properly flows through n8n's connection system

## [1.5.0] - 2026-01-02

### Added
- **Input/Output Logging**: Implemented comprehensive LangChain callback handler for execution visibility
  - Logs input prompts sent to the model
  - Logs output responses generated by the model
  - Reports prompt tokens, completion tokens, and total tokens
  - Logs errors for debugging
  - Enabled `streamUsage: true` for real-time token usage tracking during streaming
  - Provides execution transparency similar to built-in chat model sub-nodes
  - Helps monitor API costs, usage patterns, and debug workflows

### Changed
- Added `BaseCallbackHandler` from `@langchain/core/callbacks/base` for comprehensive logging
- Model now includes callbacks configuration for full execution monitoring
- Enhanced logging matches behavior of standard n8n chat model sub-nodes

## [1.1.3] - 2025-01-14

### Fixed
- **Proper Token Refresh with n8n's OAuth2 System**: Implemented working token refresh mechanism
  - Uses `httpRequestWithAuthentication` helper to trigger n8n's OAuth2 refresh on expired tokens
  - Makes a test API request when token is expired/expiring to force refresh
  - Fetches refreshed credentials after test request
  - Includes 401 error retry logic as fallback
  - Solves the root issue: n8n only refreshes OAuth2 tokens when it sees 401 errors from HTTP requests

### Changed
- Improved token refresh to properly integrate with n8n's OAuth2 credential system
- Added comprehensive logging for token refresh attempts

## [1.1.2] - 2025-01-14

### Fixed
- **Dynamic Token Refresh**: Model methods now fetch fresh OAuth2 tokens before each API call
  - Wraps `invoke()` and `stream()` methods to refresh tokens dynamically
  - Ensures token is always fresh even when model instance is reused across workflow executions
  - Solves issue where LangChain caches expired tokens in model instance

### Changed
- Improved token refresh mechanism to work at invocation time rather than initialization time

## [1.1.1] - 2025-01-14

### Added
- **Proactive Token Refresh**: Automatically checks OAuth2 token expiry before each API call and refreshes tokens 5 minutes before expiration
  - Prevents authentication failures from expired tokens
  - Workaround for n8n's limitation where OAuth2 tokens are only refreshed on 401 errors (not 403 errors)
  - Logs token refresh attempts for debugging

### Changed
- Improved error messages for OAuth2 authentication failures
- Enhanced token validation logic in the node

### Fixed
- Token not being renewed automatically when expired (addresses n8n OAuth2 framework limitation)
